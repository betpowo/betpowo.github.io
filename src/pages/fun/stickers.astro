---
import Page from "../../components/Page.astro";
import "../../styles/global.css";
import Alpine from "alpinejs";
const _images = import.meta.glob("/public/images/stickers/*/**.png");
var images = [];

for (var bleh in _images) {
	images.push(bleh.replace("/images/stickers/", "").replace("/public", ""));
}
---

<meta content="stickers" property="og:title" />
<meta content="huh..?" property="og:description" />
<meta content="/images/stickers/betty/idiot.png" property="og:image" />
<meta content="#996666" data-react-helmet="true" name="theme-color" />
<Page
	title="betopia's fridge"
	logo={false}
	alpineData="{score:0}"
	style="overflow:hidden;"
>
	<style is:inline>
		nav {
			box-shadow: 0px 0px 3px 3px var(--col-dark);
		}
	</style>
	<div
		style="background-color: var(--col-dim); overflow: hidden; display: flex;"
	>
		<div
			id="ui"
			style="
			top: 0px;
			right: 24px;
			overflow: hidden; width: fit-content; height: fit-content; margin: 0; z-index: 5000; position: absolute;
			display: flex; gap: 12px; align-items: center; font-size: 12px; "
		>
			<button
				id="clear-button"
				style="--col: #f36; margin-left:0px;font-size: 16px;padding: 7px;"
				@click="timeout(()=>{score = 0},500);">clear</button
			>
			<button
				id="undo-button"
				style="--col: #fc6; margin-left:0px;font-size: 16px;padding: 7px;"
				@click="if (score != 0) score -= 1">undo</button
			>
			<span
				x-bind:style='"border-radius: 16px; border: 2px solid var(--col-light); margin: 8px; padding: 8px; background-color: var(--col-dark); " + "color: " + (score >= 400 ? "#f36" : "inherit")'
				x-html="'stickers: ' + score.toString()"></span>
			<audio
				style="max-width: 300px; max-height:30px; font-size: 10px; border: 2px solid #495c7f; border-radius: 999px;"
				loop
				src="/audio/minigame.mp3"
				controls></audio>
		</div>
		<div
			@click="score += 1;"
			id="canvas"
			style="overflow: hidden; width: 100vw; height: 100vh; margin: 0;
			padding: 0; cursor: cell; position: absolute; top: 0px; left: 0px;"
		>
		</div>
		<div
			id="water"
			style="position: absolute;
		width: 100%; height: 100%; z-index: 90; pointer-events: none;
		background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTKZglZ-RG5pkSwtCxYG_oDauZriw3WDAIZfQ&s');
		background-size: contain; background-clip: content-box;
		top: 0px; left: 0px;
		translate: 0% -100%;"
		>
		</div>
	</div>
	<script define:vars={{ images }} is:inline>
		var audio = new Audio("/audio/stix-spawn.mp3");
		audio.volume = 0.75;

		var stixToLoad = images;

		function randomInt(min, max) {
			var bleh = [];
			for (let i = min; i < max + 1; i++) {
				bleh.push(i);
			}
			bleh.sort((a, b) => 0.5 - Math.random());
			return bleh[0];
		}

		function randomFloat(min, max) {
			var rand = Math.random();
			return lerp(min, max, rand);
		}

		function lerp(a, b, ratio) {
			return a + ratio * (b - a);
		}
		var canvas = document.getElementById("canvas");
		canvas.addEventListener("click", (e) => {
			var img = document.createElement("img");
			img.src = `/images/stickers/${stixToLoad[randomInt(1, stixToLoad.length) - 1]}`;
			img.classList.add("sticker");
			img.style.setProperty("position", "fixed");
			img.style.setProperty("z-index", 0);
			img.style.setProperty("pointer-events", "none");
			img.onload = function () {
				img.style.setProperty(
					"left",
					(e.x - img.naturalWidth * 0.5).toString() + "px",
				);
				img.style.setProperty(
					"top",
					(e.y - img.naturalHeight * 0.5).toString() + "px",
				);

				//console.log(img.naturalWidth);

				//img.style.setProperty('translate:', e.layerX.toString() + 'px ' + e.layerY.toString() + 'px');

				canvas.appendChild(img);

				if (!e.shiftKey)
					img.style.setProperty(
						"rotate",
						(Math.random() * 360).toString() + "deg",
					);

				// how do you do it
				img.style.setProperty("scale", "0.3");
				timeout(() => {
					img.style.setProperty("scale", "1.15");
					timeout(() => {
						img.style.setProperty("scale", "1");
					}, 80);
				}, 20);

				audio.currentTime = 0;
				audio.play();
				audio.preservesPitch = false;
				audio.playbackRate = randomFloat(0.7, 1.3);
				audio.volume = randomFloat(0.75, 1);
			};
		});

		var clearAudio = new Audio("/audio/stix-clear.mp3");
		var undoAudio = new Audio("/audio/stix-undo.mp3");

		document
			.getElementById("clear-button")
			.addEventListener("click", (e) => {
				clearAudio.currentTime = 0;
				clearAudio.play();
				clearAudio.preservesPitch = false;
				clearAudio.playbackRate = randomFloat(0.9, 1.1);
				document
					.getElementById("water")
					.animate(
						[{ translate: "0% -100%" }, { translate: "0% 100%" }],
						{ duration: 1000 },
					);
				timeout(() => {
					canvas.replaceChildren();
				}, 500);
			});

		document
			.getElementById("undo-button")
			.addEventListener("click", (e) => {
				if (canvas.lastChild) {
					// how do you do it
					canvas.lastChild.style.setProperty(
						"rotate",
						randomFloat(0, 360) + "deg",
					);
					canvas.lastChild.style.setProperty("scale", "1.15");
					timeout(() => {
						canvas.lastChild.style.setProperty("scale", "0.3");
						canvas.lastChild.style.setProperty(
							"rotate",
							randomFloat(0, 360) + "deg",
						);
						timeout(() => {
							canvas.removeChild(canvas.lastChild);
						}, 40);
					}, 20);
					undoAudio.currentTime = 0;
					undoAudio.play();
					undoAudio.preservesPitch = false;
					undoAudio.playbackRate = randomFloat(0.6, 1.4);
				}
			});
	</script>
</Page>
